<!DOCTYPE html>
<html lang="zh-CN" layout:decorate="~{layout/hadmin}">
<head>
	<title>数据源</title>
</head>
<body layout:fragment="content" class="gray-bg">
	<div class="wrapper wrapper-content">
		<div class="row">
			<div class="col-sm-4">
				<div class="ibox">
					<div class="ibox-content" style="border-top: none;">
						<button type="button" 
							class="btn btn-block btn-primary compose-mail" 
							data-backdrop="static" 
							data-toggle="modal" 
							data-target="#dsModal"
							>新建
                       	</button>
						<div class="hr-line-dashed"></div>
						<h5>已支持数据库</h5>
						<ul class="category-list" style="padding: 0;">
							<li>
								<a href="javascript:void(0);">
									<i class="fa fa-circle text-danger"></i> MySQL
								</a>
							</li>
							<li>
								<a href="javascript:void(0);">
									<i class="fa fa-circle text-primary"></i> PostgreSQL
								</a>
							</li>
						</ul>
					</div>
				</div>
				<div class="white-bg no-padding animated fadeInUp">
               		<table id="dsTable" class="layui-hide" lay-filter="dsTable"></table>
         		</div>
			</div>
			<div class="col-sm-8 animated fadeInRight">
				<div class="ibox">
					<div class="ibox-title">
                        <h5>数据库表</h5>
                    </div>
					<div class="ibox-content">
						<div class="row m-b-sm m-t-sm">
		                    <div class="col-md-1">
		                        <button type="button" class="btn btn-white btn-sm" onclick="refreshErTable(this);">
		                        	<i class="fa fa-refresh"></i> 刷新
		                        </button>
		                    </div>
		                    <div class="col-md-11">
		                        <div class="input-group">
		                            <input type="text" id="keywords" placeholder="请输入关键字" class="input-sm form-control" /> 
		                            <span class="input-group-btn" onclick="searchErTable(this);">
		                                <button type="button" class="btn btn-sm btn-primary"> 搜索</button> 
		                      		</span>
		                        </div>
		                    </div>
		            	</div>
						<table id="erTable" class="layui-hide" lay-filter="erTable"></table>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="modal" id="dsModal" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog">
			<div th:replace="fragments/spinners::circle"></div>
			<div class="modal-content animated flipInY">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">
						<span aria-hidden="true">&times;</span>
						<span class="sr-only">Close</span>
					</button>
					<h4 class="modal-title">新建数据源</h4>
				</div>
				<div class="modal-body">
					<form class="form-horizontal m-t-none" id="dsForm">
						<div class="form-group">
							<label class="col-sm-3 control-label">JDBC链接</label>
							<div class="col-sm-8">
								<input name="url" 
									type="text" 
									class="form-control required"
									placeholder="必填"
									autocomplete="off"
									data-vmsg="必填" 
									/>
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-3 control-label">Schema</label>
							<div class="col-sm-8">
								<input name="schema" 
									type="text" 
									class="form-control" 
									autocomplete="off" 
									/>
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-3 control-label">访问账号</label>
							<div class="col-sm-8">
								<input name="username" 
									type="text" 
									class="form-control required"
									placeholder="必填"
									autocomplete="off" 
									data-vmsg="必填" 
									/>
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-3 control-label">认证密码</label>
							<div class="col-sm-8">
								<input name="password" 
									type="password" 
									class="form-control required"
									placeholder="必填"
									autocomplete="new-password" 
									data-vmsg="必填" 
									/>
							</div>
						</div>
						<div class="form-group m-b-n-sm">
							<label class="col-sm-3 control-label">备注</label>
							<div class="col-sm-8">
								<textarea name="remark" 
									class="form-control" 
									rows="3">
								</textarea>
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
					<button type="button" class="btn btn-primary" onclick="submitDsForm();">保存</button>
				</div>
			</div>
		</div>
	</div>
	<script type="text/html" id="dsToolbar">
  		<div class="layui-btn-container">
        	<button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="delete"> 删除 </button>
     	</div>
	</script>
	<script type="text/html" id="erToolbar">
  		<div class="layui-btn-container">
        	<button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="createGraph"> 生成ER图 </button>
     	</div>
	</script>
	<script type="text/javascript">
		var dsTableId = "#dsTable";
		var dsTable = null;
		var erTableId = "#erTable";
		var erTable = null;
		$(function () {
			/**
			 * 重置表单
			 */
			$("#dsModal").on("show.bs.modal", function () {
				$("#dsForm").clearform();
			}).on("hide.bs.modal", function () {
				$("#dsForm").clearform();
			});
			/**
			 * 初始化表格-数据源
			 */
			 dsTable = layui.table.render({
					elem: dsTableId,
					toolbar: "#dsToolbar",
					defaultToolbar: [ "filter", "print" ],
					url: "[(@{/ds/ajax/list})]",
					page: true,
					parseData: function (res) {
						return {
							code: 0,
							msg: null,
							data: res.records,
							count: res.total
						};
					},
					cols: [ [
							{ field: "uuid", type: "checkbox", width: 80 },
							{ field: "url", title: "JDBC链接", minWidth: 250 },
							{ field: "schema", title: "Schema", hide: true, minWidth: 100 },
							{ field: "username", title: "账号", hide: true, minWidth: 80 },
							{ field: "remark", title: "备注", hide: true, minWidth: 120 },
							{ field: "updatedAt", title: "更新时间", width: 145, align: "right", templet: function (res) { return layui.util.toDateString(res.updatedAt, "yyyy-MM-dd HH:mm"); } }
						] ],
					done: function (res, curr, count) {
						$(dsTableId).next().addClass("no-margins");
					}
				});
			// 监听事件-数据源
			layui.table.on("toolbar(dsTable)", function (obj) {
					var checkStatus = layui.table.checkStatus(obj.config.id);
					switch (obj.event) {
				  		case "delete":
				  			if(checkStatus.data.length === 0) {
				  				layer.msg("请勾选要删除的数据源", { icon: 5, shift:6, time: 1200, offset: [ "300px", "150px" ] });
				  				return;
				  			}
				  			var uuids = "";
				  			checkStatus.data.forEach(function (item,index) {
	           					if(index == 0) {
	           						uuids = item.uuid;
	           					} else {
	           						uuids += "," + item.uuid;
	           					}
	           				});
				  			$.post("[(@{/ds/ajax/del})]", 
	           						{ uuids: uuids }, 
	           						function (resJson) {
			      						if(resJson.statusCode == 200) {
			      							dsTable.reload({});
			    							erTable.reload({});
			      							$.toastrSuccess("数据源已删除");
							          	} else {
							          		swal("出错了", resJson.message ? resJson.message : "系统异常", "error");
							        	}
	    							});
				     	break;
					};
				});
			/**
			 * 初始化表格-数据库表
			 */
			 erTable = layui.table.render({
					elem: erTableId,
					toolbar: "#erToolbar",
					defaultToolbar: [ "filter", "print" ],
					url: "[(@{/er/ajax/page})]",
					page: true,
					request: {
						pageName: "current",
					 	limitName: "size"
					},
					parseData: function (res) {
						return {
							code: 0,
							msg: null,
							data: res.records,
							count: res.total
						};
					},
					cols: [ [
							{ field: "uuid", type: "checkbox", width: 80 },
							{ field: "tableName", title: "表名", templet: function (res) { return '<a href="javascript:void(0);" onclick="lookTableFields(\'' + res.uuid + '\',\'' + res.tableName + '\');">' + res.tableName + '</a>'; }  },
							{ field: "comment", title: "注释" },
							{ field: "updatedAt", title: "更新时间", width: 145, align: "right", templet: function (res) { return layui.util.toDateString(res.updatedAt, "yyyy-MM-dd HH:mm"); } }
						] ],
					done: function (res, curr, count) {
						$(erTableId).next().addClass("no-margins");
					}
				});
			// 监听事件-数据库表
			layui.table.on("toolbar(erTable)", function (obj) {
					var checkStatus = layui.table.checkStatus(obj.config.id);
					switch (obj.event) {
				  		case "createGraph":
				  			if(checkStatus.data.length === 0) {
				  				layer.msg("请勾选要生成ER图的表", { icon: 5, shift:6, time: 1200, offset: "200px" });
				  				return;
				  			}
				  			var uuids = "";
				  			checkStatus.data.forEach(function (item,index) {
	           					if(index == 0) {
	           						uuids = item.uuid;
	           					} else {
	           						uuids += "," + item.uuid;
	           					}
	           				});
		          			layer.prompt({
									title: "新建ER设计图",
									offset: "200px",
									formType: 0, 
									value: null,
									skin: "layui-layer-rim layui-layer-prompt"
								}, function (value, index, elem) {
			           				$.post("[(@{/er/ajax/createGraph})]", 
			           						{ name: value, uuids: uuids }, 
			           						function (resJson) {
					      						if(resJson.statusCode == 200) {
				           							layer.close(index);
					      							$.toastrSuccess(value + "，ER图已添加");
									          	} else {
									          		swal("出错了", resJson.message ? resJson.message : "系统异常", "error");
									        	}
			    							});
										});
				     	break;
					};
				});
		});
		/**
		 * 提交数据源表单
		 */
		function submitDsForm () {
			var dsForm = $("#dsForm");
			// 表单校验
			if(dsForm.valiform()) {
				$("#dsModal").find(".spiner-loading").addClass("show");
   				$.post(ctx + '/ds/ajax/save', 
   					dsForm.formJson(), 
   					function (resJson) {
   						$("#dsModal").find(".spiner-loading").removeClass("show");
						if(resJson.statusCode == 200) {
							dsTable.reload({});
							erTable.reload({});
							$.toastrSuccess("数据源已添加");
							$("#dsModal").modal("hide");
			          	} else {
			          		swal("出错了", resJson.message ? resJson.message : "系统异常", "error");
			        	}
					});		
			}
		}
		/**
		 * 刷新数据库表
		 */
		function refreshErTable (e) {
			$.simpleLoad($(e), true);
			erTable.reload({
				done: function (res, curr, count) {
					$.simpleLoad($(e), false);
				}
			});
		}
		/**
		 * 搜索数据库表
		 */
		function searchErTable (e) {
			erTable.reload({
				page: { 
					curr: 1 
				},
				where: {
					keywords: $("#keywords").val()
				}
			});
		}
		/**
		 * 查看数据库表字段
		 */
		function lookTableFields (erUuid, tableName) {
			layer.open({
				type: 2, 
				title: tableName,
				maxmin: true,
				area: [ "100%", "100%" ],
				content: [ctx + "/erField/dialog?erUuid=" + erUuid, "no"]
			});
		}
	</script>
</body>
</html>