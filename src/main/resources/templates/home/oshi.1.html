<!DOCTYPE html>
<html lang="zh-CN" layout:decorate="~{layout/decorate}">
<head>
    <title>服务器</title>
    <link th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" rel="stylesheet" />
</head>
<body layout:fragment="content">
    <div id="vue-app" class="container-fluid" style="margin-top: 20px;" v-cloak>
    	<div class="row" v-for="(item, key, index) in serverMap" v-bind:data-machine="item.machine">
    		<div class="col-md-12">
	            <div class="panel panel-default">
	                <div class="panel-heading">
	                    <i class="fa fa-server"></i> 
	               		<span>服务器信息，机器ip：{{item.machine}}，磁盘：{{item.diskStr}}，已使用磁盘：{{item.diskUsedStr}}，磁盘使用率：{{item.diskUsedRate}} %</span>
	                </div>
	                <div class="panel-body" style="border-width: 0px;">
	                	<div class="topjui-row">
	                		<div class="layui-col-lg4 layui-col-sm4 topjui-col-xs12">
			                    <ul>
			                        <li>操作系统：{{item.osName}}</li>
			                        <li>系统架构：{{item.osArch}}</li>
			                        <li>Cpu 核心数：{{item.cpuCores}}</li>
			                        <li>Cpu 使用率：{{item.cpuUsedRate}} %</li>
			                    </ul>
		                    </div>
	                		<div class="layui-col-lg4 layui-col-sm4 topjui-col-xs12">
			                    <ul>
			                        <li>系统内存：{{item.memoryStr}}</li>
			                        <li>已使用系统内存：{{item.memoryUsedStr}}</li>
			                        <li>系统内存使用率：{{item.memoryUsedRate}} %</li>
			                    </ul>
		                    </div>
	                		<div class="layui-col-lg4 layui-col-sm4 topjui-col-xs12">
			                    <ul>
			                        <li>Java 运行版本：{{item.javaVersion}}</li>
			                        <li>Jvm 内存总量：{{item.jvmMemoryStr}}</li>
			                        <li>Jvm 已使用内存：{{item.jvmMemoryUsedStr}}</li>
			                        <li>Jvm 内存使用率：{{item.jvmMemoryUsedRate}} %</li>
			                    </ul>
		                    </div>
	                    </div>
	                    <div class="topjui-row">
					    	<div class="layui-col-lg4 layui-col-sm4 topjui-col-xs12">
					    		<div v-bind:id="'cpu-' + item.machine" style="height: 300px;"></div>
					    	</div>
					    	<div class="layui-col-lg4 layui-col-sm4 topjui-col-xs12">
					    		<div v-bind:id="'memory-' + item.machine" style="height: 300px;"></div>
					    	</div>
					    	<div class="layui-col-lg4 layui-col-sm4 topjui-col-xs12">
					    		<div v-bind:id="'jvm-' + item.machine" style="height: 300px;"></div>
					    	</div>
						</div>
	                </div>
	            </div>
	        </div>
    	</div>
	</div>
	<a th:href="@{/home/oshi?type=2}" class="github-corner" aria-label="切换视图"><svg width="60" height="60" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position: absolute;top: 0;border: 0;right: 0;z-index: 1000;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>
<script th:src="@{/webjars/reconnecting-websocket/reconnecting-websocket.js}"></script>
<script th:src="@{/webjars/bootstrap/js/bootstrap.min.js}"></script>
<script th:src="@{/webjars/echarts/echarts.min.js}"></script>
<script th:src="@{/webjars/vue/vue.min.js}"></script>
<script type="application/javascript">
	OshiChart = { echarts: { }, option: { } };
	var protocol = document.location.protocol;
	var timestamp = new Date().getTime();
	var webSocketHost = protocol.indexOf("https") > -1?"[(${#ConfigUtil.wssHost})]":"[(${#ConfigUtil.wsHost})]";
	var token = Base64.encodeURI("[(${#session.id})]@" + timestamp);
	var WS = new ReconnectingWebSocket(webSocketHost + "[(@{/ws/})]" + token);
	
   	function createRateEcharts (id, title, data) {
   		OshiChart.echarts[id] = echarts.init(document.getElementById(id));
   		OshiChart.option[id] = {
    			title: {
    		    	left: "center",
    		    	top: 20,
    		        text: title
    		    },
    		    tooltip: {
    		        trigger: "axis",
    		        formatter: function (params) {
    		        	var param = params[0];
    		        	var htmlStr = param.seriesName + '<br/>';
                			htmlStr += '<div>';
				          	htmlStr +=     '<span style="margin-right:5px;display:inline-block;width:10px;height:10px;border-radius:5px;background-color:#3eb177;"></span>';
				          	htmlStr +=     '日&#12288;期：' + layui.util.toDateString(param.name, "yyyy/MM/dd");
				          	htmlStr += '</div>';
                			htmlStr += '<div>';
				          	htmlStr +=     '<span style="margin-right:5px;display:inline-block;width:10px;height:10px;border-radius:5px;background-color:#f2637b;"></span>';
				          	htmlStr +=     '时&#12288;间：' + layui.util.toDateString(param.name, "HH:mm:ss");
				          	htmlStr += '</div>';
                			htmlStr += '<div>';
				          	htmlStr +=	   '<span style="margin-right:5px;display:inline-block;width:10px;height:10px;border-radius:5px;background-color:#fbd444;"></span>';
				          	htmlStr +=     '使用率：' + param.value[1] + ' %';
				          	htmlStr += '</div>';
                		return htmlStr;
    		        },
    		        axisPointer: {
    		            animation: false
    		        }
    		    },
    		    xAxis: {
    		        type: "time",
    		        splitLine: {
    		            show: false
    		        }
    		    },
    		    yAxis: {
    		        type: "value",
    		        min: 0,
    		        max: 100,
    		        boundaryGap: [ 0, "100%" ],
    		        splitLine: {
    		            show: false
    		        },
    		        axisLabel: {
    		        	show: true,  
                           interval: "auto",  
                           formatter: "{value} %"
    		        }
    		    },
    		    series: [{
    		        name: title,
    		        type: "line",
    		        showSymbol: false,
    		        hoverAnimation: false,
    		        data: data
    		    }]
    		};
   		
   		OshiChart.echarts[id].setOption(OshiChart.option[id]);
   		var originFn = window.onresize;
   		window.onresize = function () { 
   			originFn && originFn();
   			OshiChart.echarts[id].resize(); 
   		}
   	}
   	
   	WS.onopen = function (evt) {
   		VM = new Vue({
   		    el: "#vue-app",
   		    data: { 
   		    	timer: null,
   		    	serverMap: { }
   		    },
   		    created() { 
   	            this.findMachines();
   		    },
   		    methods: {
   	            findMachines: function() {
   	                var that = this;
   	                fetch("[(@{/oshi/machines})]")
   	                .then(function(response) {
   	                    return response.json();
   	                })
   	                .then(function(json){
   	                	var tempMachineMap = {};
   	                	$.each(json, function(key, item) {
   	                		tempMachineMap[key] = item;
   	                		if(!that.serverMap[key]) {
   	                			that.$set(that.serverMap, key, item);
   	                			WS.send(item.machine);
   	                		}
   	                	});
   	                	$.each(that.serverMap, function(key, item) {
   	                		if(!tempMachineMap[key]) {
   	                			that.$delete(that.serverMap, key);
   	                		}
   	                	});
   	                });
   	            }
   	        },
   	      	mounted() {
   	            this.timer = setInterval(this.findMachines, 8000);
   	     	},
   	     	beforeDestroy() {
   	            clearInterval(this.timer);
   	   		}
   	    });
   	}
   	
   	WS.onmessage = function (evt) { 
   		var message = JSON.parse(evt.data);
   		if(message instanceof Array) {
   			var cpuId = null;
   			var memId = null;
   			var jvmId = null;
   			
   			var cpuUsedRateData = [];
   			var memUsedRateData = [];
   			var jvmUsedRateData = [];
   			
   			$.each(message, function (i, item) {
   				if(!cpuId || !memId || !jvmId) {
   					cpuId = "cpu-" + item.machine;
   					memId = "memory-" + item.machine;
   					jvmId = "jvm-" + item.machine;
   				}
   				
   				cpuUsedRateData.push({ name: item.createdAt, value: [ item.createdAt, item.cpuUsedRate ] });
   				memUsedRateData.push({ name: item.createdAt, value: [ item.createdAt, item.memoryUsedRate ] });
   				jvmUsedRateData.push({ name: item.createdAt, value: [ item.createdAt, item.jvmMemoryUsedRate ] });
   			});
   			
   			cpuUsedRateData.reverse();
   			memUsedRateData.reverse();
   			jvmUsedRateData.reverse();
   			
   			createRateEcharts(cpuId, "Cpu使用率", cpuUsedRateData);
   			createRateEcharts(memId, "系统内存使用率", memUsedRateData);
   			createRateEcharts(jvmId, "Jvm内存使用率", jvmUsedRateData);
   		} else {
   			$.each(message, function (key, item) {
   				var _cpuId = "cpu-" + item.machine;
   				var _memId = "memory-" + item.machine;
   				var _jvmId = "jvm-" + item.machine;
   				
   				if(OshiChart.echarts[_cpuId] && OshiChart.echarts[_memId] && OshiChart.echarts[_jvmId]) {
   					
   					VM.$set(VM.serverMap, key, item);
   					
   					if(OshiChart.option[_cpuId].series[0].data.length > 12*15) { OshiChart.option[_cpuId].series[0].data.shift(); }
   					OshiChart.option[_cpuId].series[0].data.push({ name: item.createdAt, value: [ item.createdAt, item.cpuUsedRate ] });
   					OshiChart.echarts[_cpuId].setOption(OshiChart.option[_cpuId]);
   					
   					if(OshiChart.option[_memId].series[0].data.length > 12*15) { OshiChart.option[_memId].series[0].data.shift(); }
   					OshiChart.option[_memId].series[0].data.push({ name: item.createdAt, value: [ item.createdAt, item.memoryUsedRate ] });
   					OshiChart.echarts[_memId].setOption(OshiChart.option[_memId]);
   					
   					if(OshiChart.option[_jvmId].series[0].data.length > 12*15) { OshiChart.option[_jvmId].series[0].data.shift(); }
   					OshiChart.option[_jvmId].series[0].data.push({ name: item.createdAt, value: [ item.createdAt, item.jvmMemoryUsedRate ] });
   					OshiChart.echarts[_jvmId].setOption(OshiChart.option[_jvmId]);
   				}
   			});
   		}
   	}
   	
   	WS.onclose = function (evt) { console.log("WebSocket closed"); }


</script>
</body>
</html>