<div class="easyui-layout"
	data-options="fit:true">
	<div data-options="region:'center',
			split:true,
			border:false
		">
		<table id="userDataGrid" 
			class="easyui-datagrid"
		 	th:data-options="|border:false,
				fit:true,
				fitColumns:true,
				singleSelect:true,
				checkOnSelect:false,
				selectOnCheck:false,
				toolbar:'#userDataGridToolbar',
				pagination:true,
				pageSize:20,
				method:'get',
				url:ctx+'/doc/projectMember/ajax/authAccessPage?docProjectUuid=${uuid}',
		   		onBeforeLoad:function(param){
		       		try{
		      			$.pageOnBeforeLoad(param);
		         		param.orgIds = $('#userDataGridForm-orgIds').combo('getValue');
						param.accessAuth = $('#userDataGridForm-accessAuth').combo('getValue');
						param.keywords = $('#userDataGridForm-keywords').textbox('getValue');
		           	}catch(e){
		           	}
		     	}
			|">
			<thead>
				<tr>
		      		<th data-options="field:'memberUserId',title:'用户ID',checkbox:true"></th>
		            <th data-options="field:'nickname',title:'昵称',width:120"></th>
		            <th data-options="field:'role',title:'权限',width:80,formatter:$.docMemberRoleFormatter"></th>
		            <th data-options="field:'username',title:'账号',width:120"></th>
		            <th data-options="field:'mobile',title:'手机',width:120"></th>
		            <th data-options="field:'email',title:'邮箱',width:250"></th>
				</tr>
			</thead>
		</table>
	</div>
</div>
<!-- 授权人员 工具栏 -->
<div id="userDataGridToolbar" class="myui-toolbar">
	<a href="javascript:addRoleMember();"
    	class="easyui-menubutton myui-btn-normal myui-btn-green"
    	data-options="iconCls:'fa fa-plus',
       		hasDownArrow:false
      	">添加成员
	</a>
	<a href="javascript:removeRoleMember();"
    	class="easyui-menubutton myui-btn-normal myui-btn-red"
       	data-options="iconCls:'fa fa-minus',
      		hasDownArrow:false
       	">移除成员
	</a>
	<form id="userDataGridForm" class="search-box">
   		<input type="text" name="orgIds"
    		id="userDataGridForm-orgIds"
         	class="easyui-combotreegrid"
         	th:data-options="|fitColumns:true,
				singleSelect:true,
            	prompt:'组织机构',
            	width:220,
                panelWidth:344,
				idField:'orgId',
		   		treeField:'text',
				method:'get',
            	url:ctx+'/sys/org/ajax/getTree',
           		columns:[[
                	{field:'text',title:'组织机构名称',width:100}
               	]],
             	onLoadSuccess:function(row,data){
            		$(this).treegrid('expandAll');
            	}
          	|"/>
     	<input type="text" name="accessAuth" value="true"
        	id="userDataGridForm-accessAuth"
        	class="easyui-combobox"
        	data-options="prompt:'是否授权',
         		width:120,
				panelHeight:120,
				editable:false,
           		valueField:'value',
				textField:'text',
				data: [
				    {text:'全部',value:''},
				    {text:'已授权',value:'true'},
					{text:'未授权',value:'false'}
				]
			"/>
   		<input type="text" name="keywords"
    		id="userDataGridForm-keywords" 
   			class="easyui-textbox"
        	data-options="prompt:'昵称、账号、手机号、邮箱',
	       		width:220
        	"/>
      	<a href="javascript:searchUserDataGrid();" 
        	class="easyui-linkbutton myui-btn-blue myui-btn-normal"
       		data-options="iconCls:'fa fa-search'
         	">查询
    	</a>
    	<a href="javascript:resetUserDataGrid();"
      		class="easyui-linkbutton myui-btn-brown myui-btn-normal"
      		data-options="iconCls:'fa fa-trash'
      		">清空
    	</a>
	</form>
</div>
<script type="text/javascript">
	/**
	 * 查询授权人员
	 */
	function searchUserDataGrid () {
		$('#userDataGrid').datagrid('load', {
			orgIds: $('#userDataGridForm-orgIds').combo('getValue'),
			accessAuth: $('#userDataGridForm-accessAuth').combo('getValue'),
			keywords: $('#userDataGridForm-keywords').textbox('getValue')
		});
	}
	
	/**
	 * 重置授权人员
	 */
	function resetUserDataGrid () {
		$('#userDataGridForm').form('clear');
		searchUserDataGrid();
	}
	
	/**
	 * 添加成员
	 */
	function addRoleMember () {
		var checked = $('#userDataGrid').datagrid('getChecked');
		if (!checked || checked.length === 0) {
			$.messager.myuiAlert('操作提示', '请先勾选中要操作的数据前的复选框！', 'warning');
			return;
		} else {
			var userIds = [];
			$.each(checked, function (i, item) {
				userIds[i] = item.memberUserId;
			});
			selectRoleDialog(function (role) {
				$.messager.myuiConfirm('确认提示', '确定要执行该操作吗？', function (r) {
					if (r) {
						$.messager.progress({'text': '请求中……'});
						$.post(ctx+'/doc/projectMember/ajax/addRoleMember', 
								{ role: role, docProjectUuid: '[(${uuid})]', userIds: userIds.join() }, 
								function (resultJson) {
					                $.messager.progress('close');
									if (resultJson.statusCode == 200) {
										$.messager.show({title: '我的消息', msg: resultJson.message?resultJson.message:'操作成功', timeout: 5000, showType: 'slide'});
					                	searchUserDataGrid();
					                } else {
					                    $.messager.show({title: '我的消息', msg: resultJson.message?resultJson.message:'出错了', timeout: 5000, showType: 'slide'});
					                }
								});
					}
				});
			});
		}
	}
	
	/**
	 * 移除成员
	 */
	function removeRoleMember () {
		var checked = $('#userDataGrid').datagrid('getChecked');
		if (!checked || checked.length === 0) {
			$.messager.myuiAlert('操作提示', '请先勾选中要操作的数据前的复选框！', 'warning');
			return;
		} else {
			var userIds = [];
			$.each(checked, function (i, item) {
				userIds[i] = item.memberUserId;
			});
			$.messager.myuiConfirm('确认提示', '确定要执行该操作吗？', function (r) {
				if (r) {
					$.messager.progress({'text': '请求中……'});
					$.post(ctx+'/doc/projectMember/ajax/removeRoleMember', 
							{ docProjectUuid: '[(${uuid})]', userIds: userIds.join() }, 
							function (resultJson) {
				                $.messager.progress('close');
								if (resultJson.statusCode == 200) {
									$.messager.show({title: '我的消息', msg: resultJson.message?resultJson.message:'操作成功', timeout: 5000, showType: 'slide'});
				                	searchUserDataGrid();
				                } else {
				                    $.messager.show({title: '我的消息', msg: resultJson.message?resultJson.message:'出错了', timeout: 5000, showType: 'slide'});
				                }
							});
				}
			});
		}
	}
	
	/**
	 * 项目弹窗（新增|编辑）
	 */
	function selectRoleDialog (callback) {
		var $selectRoleDialog = $('<form id="selectRoleDialog" class="myui" style="overflow-x: hidden;"></form>');
	    $selectRoleDialog.myuiDialog({
	        title: "授权角色",
	        width: 890,
	        height: 483,
			collapsible: true,
			minimizable: false,
			maximizable: true,
	        closed: false,
	        cache: false,
			maximized: false,
			modal: true,
            content: 'x',
	        buttons: [{
	            text: '确定',
	            iconCls: 'fa fa-save',
	            handler: function () {
					
				}
	        }, {
	            text: '关闭',
	            iconCls: 'fa fa-close',
	            handler: function () {
	                $selectRoleDialog.dialog('destroy');
	            }
	        }],
			onClose: function () {
				$selectRoleDialog.dialog('destroy');
			}
	    });
	}
</script>