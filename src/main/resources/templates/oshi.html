<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<title>服务器</title>
    <meta charset="UTF-8" />
	<meta name="renderer" content="webkit" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <link th:href="@{/static/favicon.ico}" rel="shortcut icon" />
    <link rel="stylesheet" th:href="@{/static/css/oshi.css}" />
</head>
<body>
    <div id="container">
        <div data-popo="caption" title="实时监控" class="se-title"></div>
        <div data-popo="chart1" title="Cpu"></div>
        <div data-popo="chart2" title="内存"></div>
        <div data-popo="chart3" title="磁盘"></div>
        <div data-popo="chart4" title="Chart D"></div>
        <div data-popo="chart5" title="在线人数"></div>
        <div data-popo="chart6" title="服务节点数"></div>
        <div data-popo="chart7" title="Java虚拟机"></div>
        <div data-popo="chart8" title="Chart H"></div>
    </div>
    <script th:src="@{/static/popo/popo.min.js}"></script>
    <script th:src="@{/webjars/reconnecting-websocket/reconnecting-websocket.js}"></script>
    <script th:src="@{/webjars/jquery/jquery.min.js}"></script>
    <script th:src="@{/webjars/js-base64/base64.min.js}"></script>
    <script th:src="@{/webjars/echarts/echarts.min.js}"></script>
    <script type="text/javascript">
    	$(function() {
    		var OSHI_UID = [];
    		var OSHI_POOL = [];
    		var protocol = document.location.protocol;
    		var timestamp = new Date().getTime();
    		var webSocketHost = protocol.indexOf("https") > -1?"[(${#MyConfig.wssHost})]":"[(${#MyConfig.wsHost})]";
    		var token = Base64.encodeURI("[(${session.SPRING_SECURITY_CONTEXT.authentication.principal.token})]@" + timestamp);
    		var WS = new ReconnectingWebSocket(webSocketHost + "[(@{/ws/})]" + token);
    		
    		// 扩展数组方法
    		Array.prototype.contains = function(obj) {
    			var i = this.length;
    			while (i--) {
    				if (this[i] === obj) {
    			   		return true;
    				}
    			}
    			return false;
    		}
    		
    		// 打开连接
    		WS.onopen = function (evt) {
    			WS.send(JSON.stringify({type: "oshi"}));
    		}

    		// 接收消息
    		WS.onmessage = function (evt) {
    			var message = JSON.parse(evt.data);
    			// 服务器信息
    			if(message.type == "oshi") {
    				$.each(message.data, function (key, data) {
    					if(data instanceof Array) {
    						$.each(data, function (i, item) {
    							if(!OSHI_UID.contains(item.uid)) { OSHI_UID.push(item.uid); OSHI_POOL.push(item); }
            					if(OSHI_UID.length > 12) { OSHI_UID.shift(); }
            					if(OSHI_POOL.length > 12 * 60) { OSHI_POOL.shift(); }
    			   			});
    					} else {
    						if(!OSHI_UID.contains(data.uid)) { OSHI_UID.push(data.uid); OSHI_POOL.push(data); }
        					if(OSHI_UID.length > 12) { OSHI_UID.shift(); }
        					if(OSHI_POOL.length > 12 * 60) { OSHI_POOL.shift(); }
    					}
    				});
    				console.log(OSHI_POOL);
    			}
    		}

    		// 连接关闭
    		WS.onclose = function (evt) {
    			console.log("WebSocket closed");
    		}
    	});
    </script>
    <script type="text/javascript">
        /**
         *  PoPo Data Visualization for multi screen.
         *  This example defines the mobile phone screen, ordinary notebook screen, PC screen, large screen screen data of four kinds of mode, you can try in different modes of viewing this example, if there is no suitable screen, in the following code prompt to view large screen effect in common screen
         * 
         *  多屏适配数据可视化示例
         *  本示例定义了手机端、普通笔记本屏幕(分辨率宽度低于1440)、PC屏幕(1920*1080)、超大屏四种模式的大屏数据化，你可以尝试在不同模式下查看本示例，如果没有合适的大屏，在最下面的代码中有提示可在普通屏幕上查看大屏效果。
         * 
         */

        // Define a bigscreen PoPo instance.
        var bigscreen = null;

        $(function () {

            /**
             * Fetch chart data.
             * @param {String} name popo alias name
             * @param {Function} success success callback
             */
            function fetchData(name, success) {
                $.getJSON('[(@{/static/popo/data/})]' + name + '.json', function (result) {
                    if (result) {
                        // This chart must be assigned.
                        if (name === 'chart6') {
                            result.series = (function () {
                                var series = [];
                                for (var i = 1; i <= 28; i++) {
                                    series.push({
                                        name: 'Browser',
                                        type: 'radar',
                                        symbol: 'none',
                                        itemStyle: {
                                            normal: {
                                                lineStyle: {
                                                    width: 1
                                                }
                                            },
                                            emphasis: {
                                                areaStyle: { color: 'rgba(0,250,0,0.3)' }
                                            }
                                        },
                                        data: [
                                            {
                                                value: [
                                                    (40 - i) * 10,
                                                    (38 - i) * 4 + 60,
                                                    i * 5 + 10,
                                                    i * 9,
                                                    i * i / 2
                                                ],
                                                name: i + 2000 + ''
                                            }
                                        ]
                                    });
                                }
                                return series;
                            })()
                        }
                        // This chart must be assigned.
                        if (name === 'chart8') {
                            result.tooltip.formatter = function (params) {
                                if (params.value.length > 1) {
                                    return params.seriesName + ' :<br/>' +
                                        params.value[0] + 'cm ' +
                                        params.value[1] + 'kg ';
                                } else {
                                    return params.seriesName + ' :<br/>' +
                                        params.name + ' : ' +
                                        params.value + 'kg ';
                                }
                            }
                        }
                    }
                    if (typeof success === 'function') {
                        success(result);
                    }
                });
            }

            /**
             * PoPo instance update hook
             * @param {Object} popo PoPo instance
             */
            function update(popo) {
                popo.each(function (elements) {
                    if (elements.center) {
                        var chart = echarts.getInstanceByDom(elements.center);
                        chart && chart.resize();
                    }
                });
            }

            /**
             * PoPo instance onload hook
             * @param {Object} popo PoPo instance
             */
            function onload(popo) {
                popo.getAlias().forEach(function (alias) {
                    // Initialize chart.
                    if (alias.type === 'chart') {
                        fetchData(alias.name, function (data) {
                            var target = popo.center(alias.name);
                            if (data && target) {
                                echarts.init(target).setOption(data);
                            }
                        });
                    }
                    // Setting summary panel vertical middle.
                    if (alias.type === 'summary') {
                        var panel = popo.center(alias.name);
                        if (panel) {
                            var summaryEl = panel.querySelector('.summary');
                            if (summaryEl) {
                                var parentHeight = $(panel).height();
                                var height = $(summaryEl).height();
                                $(summaryEl).css({
                                    paddingTop: (parentHeight - height) / 2 + 'px'
                                })

                            }
                        }

                    }
                });

            }

            $.getJSON('[(@{/static/popo/data/popo.json})]', function (result) {
                if (!result) return;
                var width = P.Browser.width,
                    height = P.Browser.height,
                    option = null,
                    base = result.base,
                    mobile = result.mobile,
                    screen_1920 = result.screen_1920,
                    screen_1440 = result.screen_1440,
                    screen_bigger = result.screen_bigger;

                if (P.Browser.mobile) {
                    option = mobile;
                } else {
                    option = width <= 1440 ? screen_1440 : (width >= 3840 && height >= 1000 ? screen_bigger : screen_1920);
                }
                /**
                 * You can cancel the comment for the following code and see the effect of the big screen on the ordinary screen.
                 * 可以取消下面的代码注释，在普通屏幕上查看大屏的效果
                 */

                // option = screen_bigger;
                // option.width = 7160;
                // option.height = 2160;
                // option.fontScale = 3.5;
                // option.zoom = {
                //     enable: true,
                //     scale: 0.4
                // };
                if (option) {
                    option.onload = onload;
                    option.update = update;
                    bigscreen = P.init(P.Util.merge(option, base)).addTo("container");
                }
            });
        });
    </script>
</body>
</html>