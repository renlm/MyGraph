!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base","./grid.grouping"],e):e(jQuery)}(function(Q){"use strict";Q.assocArraySize=function(e){var r,o=0;for(r in e)e.hasOwnProperty(r)&&o++;return o},Q.jgrid.extend({pivotSetup:function(H,e){var N=[],A=[],k=[],G=[],M=[],z={grouping:!0,groupingView:{groupField:[],groupSummary:[],groupSummaryPos:[]}},V=[],q=Q.extend({rowTotals:!1,rowTotalsText:"Total",colTotals:!1,groupSummary:!0,groupSummaryPos:"header",frozenStaticCols:!1},e||{});return this.each(function(){var p,d,f,e,r,c=this,o=H.length,t=0;function a(e,r,o){o=function(e,r){var o,t,a,n=[];if(!this||"function"!=typeof e||e instanceof RegExp)throw new TypeError;for(a=this.length,o=0;o<a;o++)if(this.hasOwnProperty(o)&&(t=this[o],e.call(r,t,o,this))){n.push(t);break}return n}.call(e,r,o);return 0<o.length?o[0]:null}function n(e,r){var o,t=0,a=!0;for(o in e)if(e.hasOwnProperty(o)){if(e[o]!=this[t]){a=!1;break}if(++t>=this.length)break}return a&&(w=r),a}function i(e,r,o,t){var a,n,i,s,l=r.length,g="",u=[],m=1;for(Array.isArray(o)?(i=o.length,u=o):(i=1,u[0]=o),M=[],n=(G=[]).root=0;n<i;n++){for(var p,d=[],f=0;f<l;f++){if(s="string"==typeof r[f].aggregator?r[f].aggregator:"cust",null==o)p=a=Q.jgrid.trim(r[f].member)+"_"+s,u[0]=r[f].label||s+" "+Q.jgrid.trim(r[f].member);else{p=o[n].replace(/\s+/g,"");try{a=1===l?g+p:g+p+"_"+s+"_"+String(f)}catch(e){}u[n]=o[n]}a=isNaN(parseInt(a,10))?a:a+" ","avg"===r[f].aggregator&&(s=-1===w?A.length+"_"+a:w+"_"+a,h[s]?h[s]++:h[s]=1,m=h[s]),t[a]=d[a]=function(e,r,o,t,a){var n;if(Q.jgrid.isFunction(e))n=e.call(c,r,o,t);else switch(e){case"sum":n=parseFloat(r||0)+parseFloat(t[o]||0);break;case"count":""!==r&&null!=r||(r=0),n=t.hasOwnProperty(o)?r+1:0;break;case"min":n=""===r||null==r?parseFloat(t[o]||0):Math.min(parseFloat(r),parseFloat(t[o]||0));break;case"max":n=""===r||null==r?parseFloat(t[o]||0):Math.max(parseFloat(r),parseFloat(t[o]||0));break;case"avg":n=(parseFloat(r||0)*(a-1)+parseFloat(t[o]||0))/a}return n}(r[f].aggregator,t[a],r[f].member,e,m)}g+=o&&null!=o[n]?o[n].replace(/\s+/g,""):"",G[a]=d,M[a]=u[n]}return t}if(q.rowTotals&&0<q.yDimension.length&&(e=q.yDimension[0].dataName,q.yDimension.splice(0,0,{dataName:e}),q.yDimension[0].converter=function(){return"_r_Totals"}),p=Array.isArray(q.xDimension)?q.xDimension.length:0,d=q.yDimension.length,f=Array.isArray(q.aggregates)?q.aggregates.length:0,0===p||0===f)throw"xDimension or aggregates optiona are not set!";for(y=0;y<p;y++)r={name:q.xDimension[y].dataName,frozen:q.frozenStaticCols},null==q.xDimension[y].isGroupField&&(q.xDimension[y].isGroupField=!0),r=Q.extend(!0,r,q.xDimension[y]),N.push(r);for(var s=p-1,l={},h=[];t<o;){for(var g=H[t],u=[],m=[],v={},y=0;u[y]=Q.jgrid.trim(g[q.xDimension[y].dataName]),v[q.xDimension[y].dataName]=u[y],++y<p;);var x,b=0,w=-1;if(x=a(A,n,u)){if(0<=w){if(b=0,1<=d){for(b=0;b<d;b++)m[b]=Q.jgrid.trim(g[q.yDimension[b].dataName]),q.yDimension[b].converter&&Q.jgrid.isFunction(q.yDimension[b].converter)&&(m[b]=q.yDimension[b].converter.call(this,m[b],u,m));x=i(g,q.aggregates,m,x)}else 0===d&&(x=i(g,q.aggregates,null,x));A[w]=x}}else{if(b=0,1<=d){for(b=0;b<d;b++)m[b]=Q.jgrid.trim(g[q.yDimension[b].dataName]),q.yDimension[b].converter&&Q.jgrid.isFunction(q.yDimension[b].converter)&&(m[b]=q.yDimension[b].converter.call(this,m[b],u,m));v=i(g,q.aggregates,m,v)}else 0===d&&(v=i(g,q.aggregates,null,v));A.push(v)}var D,j=0,F=null,O=null;for(D in G)if(G.hasOwnProperty(D)){if(0===j)F=(l=!l.children||void 0===l.children?{text:D,level:0,children:[],label:D}:l).children;else{for(O=null,y=0;y<F.length;y++)if(F[y].text===D){O=F[y];break}F=O?O.children:(F.push({children:[],text:D,level:j,fields:G[D],label:M[D]}),F[F.length-1].children)}j++}t++}var S,h=null,T=[],C=N.length,P=C;if(0<d&&(V[d-1]={useColSpanStyle:!1,groupHeaders:[]}),function e(r){var o,t,a,n,i;for(a in r)if(r.hasOwnProperty(a)){if("object"!=typeof r[a]){if("level"===a){if(void 0===T[r.level]&&(T[r.level]="",0<r.level&&-1===r.text.indexOf("_r_Totals")&&(V[r.level-1]={useColSpanStyle:!1,groupHeaders:[]})),T[r.level]!==r.text&&r.children.length&&-1===r.text.indexOf("_r_Totals")&&0<r.level){V[r.level-1].groupHeaders.push({titleText:r.label,numberOfColumns:0});var s=V[r.level-1].groupHeaders.length-1,l=0==s?P:C;if(r.level-1==(q.rowTotals?1:0)&&0<s){for(var g=0,u=0;u<s;u++)g+=V[r.level-1].groupHeaders[u].numberOfColumns;g&&(l=g+p)}N[l]&&(V[r.level-1].groupHeaders[s].startColumnName=N[l].name,V[r.level-1].groupHeaders[s].numberOfColumns=N.length-l),C=N.length}T[r.level]=r.text}if(r.level===d&&"level"===a&&0<d)if(1<f){var m=1;for(o in r.fields)r.fields.hasOwnProperty(o)&&(1===m&&V[d-1].groupHeaders.push({startColumnName:o,numberOfColumns:1,titleText:r.label||r.text}),m++);V[d-1].groupHeaders[V[d-1].groupHeaders.length-1].numberOfColumns=m-1}else V.splice(d-1,1)}if(null!=r[a]&&"object"==typeof r[a]&&e(r[a]),"level"===a&&0<r.level&&(r.level===(0===d?r.level:d)||-1!==T[r.level].indexOf("_r_Totals")))for(o in t=0,r.fields)if(r.fields.hasOwnProperty(o)){for(n in i={},q.aggregates[t])if(q.aggregates[t].hasOwnProperty(n))switch(n){case"member":case"label":case"aggregator":break;default:i[n]=q.aggregates[t][n]}1<f?(i.name=o,i.label=q.aggregates[t].label||r.label):(i.name=r.text,i.label="_r_Totals"===r.text?q.rowTotalsText:r.label),N.push(i),t++}}}(l),q.colTotals)for(var _=A.length;_--;)for(y=p;y<N.length;y++)S=N[y].name,k[S]?k[S]+=parseFloat(A[_][S]||0):k[S]=parseFloat(A[_][S]||0);if(0<s)for(y=0;y<s;y++)N[y].isGroupField&&(z.groupingView.groupField.push(N[y].name),z.groupingView.groupSummary.push(q.groupSummary),z.groupingView.groupSummaryPos.push(q.groupSummaryPos));else z.grouping=!1;z.sortname=N[s].name,z.groupingView.hideFirstGroupCol=!0}),{colModel:N,rows:A,groupOptions:z,groupHeaders:V,summary:k}},jqPivot:function(o,g,u,t){return this.each(function(){var l=this,e=u.regional||"en";function r(e){Q.jgrid.isFunction(g.onInitPivot)&&g.onInitPivot.call(l),Array.isArray(e)||(e=[]);var r,o,t,a,n=jQuery(l).jqGrid("pivotSetup",e,g),e=0<Q.assocArraySize(n.summary),i=Q.jgrid.from.call(l,n.rows);for(g.ignoreCase&&(i=i.ignoreCase()),r=0;r<n.groupOptions.groupingView.groupField.length;r++)o=g.xDimension[r].sortorder||"asc",t=g.xDimension[r].sorttype||"text",i.orderBy(n.groupOptions.groupingView.groupField[r],o,t,"",t);if(a=g.xDimension.length,u.sortname){for(o=u.sortorder||"asc",t="text",r=0;r<a;r++)if(g.xDimension[r].dataName===u.sortname){t=g.xDimension[r].sorttype||"text";break}i.orderBy(u.sortname,o,t,"",t)}else n.groupOptions.sortname&&a&&(o=g.xDimension[a-1].sortorder||"asc",t=g.xDimension[a-1].sorttype||"text",i.orderBy(n.groupOptions.sortname,o,t,"",t));jQuery(l).jqGrid(Q.extend(!0,{datastr:Q.extend(i.select(),e?{userdata:n.summary}:{}),datatype:"jsonstring",footerrow:e,userDataOnFooter:e,colModel:n.colModel,viewrecords:!0,formatFooterData:!0===g.colTotals,sortname:g.xDimension[0].dataName},n.groupOptions,u||{}));var s=n.groupHeaders;if(s.length)for(r=0;r<s.length;r++)s[r]&&s[r].groupHeaders.length&&jQuery(l).jqGrid("setGroupHeaders",s[r]);g.frozenStaticCols&&jQuery(l).jqGrid("setFrozenColumns"),Q.jgrid.isFunction(g.onCompletePivot)&&g.onCompletePivot.call(l),g.loadMsg&&Q(".loading_pivot").remove()}void 0===g.loadMsg&&(g.loadMsg=!0),g.loadMsg&&Q("<div class='loading_pivot ui-state-default ui-state-active row'>"+Q.jgrid.getRegional(l,"regional."+e+".defaults.loadtext")+"</div>").insertBefore(l).show(),"string"==typeof o?Q.ajax(Q.extend({url:o,dataType:"json",success:function(e){r(Q.jgrid.getAccessor(e,t&&t.reader?t.reader:"rows"))}},t||{})):r(o)})}})});